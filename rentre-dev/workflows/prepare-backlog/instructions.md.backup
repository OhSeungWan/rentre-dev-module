# Prepare Backlog - ë°±ë¡œê·¸ ë¶„ì„ ë° ì¤€ë¹„ ì›Œí¬í”Œë¡œìš°

<critical>The workflow execution engine is governed by: {project-root}/.bmad/core/tasks/workflow.xml</critical>
<critical>You MUST have already loaded and processed: {project-root}/.bmad/rentre-dev/workflows/prepare-backlog/workflow.yaml</critical>
<critical>Communicate all responses in {communication_language}</critical>
<critical>This workflow prepares a backlog for decomposition by analyzing it comprehensively and collecting context</critical>

<workflow>

<step n="1" goal="ë°±ë¡œê·¸ ì…ë ¥ ë° ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘">

<check if="invoked from another workflow with backlog_content">
  <action>ì „ë‹¬ë°›ì€ íŒŒë¼ë¯¸í„° í™•ì¸:
  - backlog_source: {backlog_source}
  - backlog_content: {backlog_content}
  - skip_save: {skip_save}
  </action>
  <goto step="2">ë°±ë¡œê·¸ ë‚´ìš© ìˆìŒ, ë¶„ì„ ì§„í–‰</goto>
</check>

<ask>ë¶„ì„í•  ë°±ë¡œê·¸ë¥¼ ì œê³µí•´ ì£¼ì„¸ìš”.

**ì…ë ¥ ë°©ì‹ ì„ íƒ:**

1. ë…¸ì…˜ URL ì…ë ¥ (auto ëª¨ë“œì—ì„œ ì§ì ‘ ë¡œë“œ)
2. ë°±ë¡œê·¸ ë‚´ìš© ì§ì ‘ ë¶™ì—¬ë„£ê¸°
3. ë…¸ì…˜ì—ì„œ ë°±ë¡œê·¸ ê²€ìƒ‰</ask>

<check if="option 1 - Notion URL">
  <check if="notion_integration == auto">
    <action>Extract page ID from URL</action>
    <action>Use Notion MCP to retrieve page:
    - GET /pages/{page_id}
    - Extract title, properties, content
    - Identify backlog type from "Type" property
    </action>
    <action>Store notion_page_id for later reference</action>
  </check>
  <check if="notion_integration != auto">
    <action>Inform: "ë…¸ì…˜ MCP ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‚´ìš©ì„ ì§ì ‘ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”."</action>
    <goto step="1">Re-ask for input</goto>
  </check>
</check>

<check if="option 2 - Direct paste">
  <ask>ë°±ë¡œê·¸ ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”:

- ì œëª©
- ìœ í˜• (Epic/Story/Task/Bug ë“±)
- ì„¤ëª…/ìš”êµ¬ì‚¬í•­
- ìˆ˜ìš© ê¸°ì¤€ (ìˆë‹¤ë©´)
- ìƒìœ„ ë°±ë¡œê·¸ ì •ë³´ (ìˆë‹¤ë©´)
- ì—°ê²°ëœ ë°±ë¡œê·¸ (ìˆë‹¤ë©´)</ask>
  </check>

<check if="option 3 - Search">
  <action>Use Notion MCP to search:
  - POST /search with user's query
  - Display matching backlogs with type and status
  - Let user select one
  </action>
</check>

<action>ë°±ë¡œê·¸ ê¸°ë³¸ ì •ë³´ íŒŒì‹± ë° ì €ì¥:

```yaml
backlog_id: { notion_page_id OR auto-generated YYYYMMDD-HHMMSS }
title: { backlog_title }
type: { backlog_type } # Epic, Story, Task, Bug, etc.
status: { current_status }
notion_id: { notion_page_id } # if from Notion
description: { raw_description }
acceptance_criteria_raw: { raw_acceptance_criteria }
```

</action>

<template-output>backlog_basic_info</template-output>
</step>

<step n="2" goal="ìƒìœ„/í•˜ìœ„/ì—°ê²° ë°±ë¡œê·¸ ì¢…í•© ë¶„ì„">
<critical>ë°±ë¡œê·¸ë¥¼ ê³ ë¦½ëœ ë‹¨ìœ„ê°€ ì•„ë‹Œ ì „ì²´ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì´í•´í•©ë‹ˆë‹¤.</critical>

<action>ìƒìœ„ ë°±ë¡œê·¸ ì •ë³´ ìˆ˜ì§‘:

**2.1 ìƒìœ„ ë°±ë¡œê·¸ íƒìƒ‰:**

<check if="notion_integration == auto AND notion_id exists">
  <action>ë…¸ì…˜ì—ì„œ Parent ê´€ê³„ ì†ì„± ì¡°íšŒ</action>
  <action>ìƒìœ„ ë°±ë¡œê·¸ê°€ ìˆìœ¼ë©´ ê¸°ë³¸ ì •ë³´ ë¡œë“œ:
  - ìƒìœ„ ë°±ë¡œê·¸ ì œëª©, ìœ í˜•, ì„¤ëª… ìš”ì•½
  - ìƒìœ„ ë°±ë¡œê·¸ì˜ ì „ì²´ ìš”êµ¬ì‚¬í•­ ë²”ìœ„
  - ìƒìœ„ ë°±ë¡œê·¸ì˜ ìˆ˜ìš© ê¸°ì¤€
  </action>
</check>

<check if="no parent found OR manual input">
  <ask>ìƒìœ„ ë°±ë¡œê·¸ ì •ë³´ê°€ ìˆë‚˜ìš”?

- [y] ì˜ˆ - ìƒìœ„ ë°±ë¡œê·¸ ì •ë³´ ì…ë ¥
- [n] ì•„ë‹ˆì˜¤ - ìµœìƒìœ„ ë°±ë¡œê·¸ì„</ask>
  <check if="y">
  <ask>ìƒìœ„ ë°±ë¡œê·¸ ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”:
- ì œëª©
- ìœ í˜•
- í•µì‹¬ ìš”êµ¬ì‚¬í•­ ìš”ì•½</ask>
  </check>
  </check>
  </action>

<action>í•˜ìœ„ ë°±ë¡œê·¸ ì •ë³´ ìˆ˜ì§‘:

**2.2 ê¸°ì¡´ í•˜ìœ„ ë°±ë¡œê·¸ íƒìƒ‰:**

<check if="notion_integration == auto AND notion_id exists">
  <action>ë…¸ì…˜ì—ì„œ Children ê´€ê³„ ì†ì„± ì¡°íšŒ</action>
  <action>ê¸°ì¡´ í•˜ìœ„ ë°±ë¡œê·¸ê°€ ìˆìœ¼ë©´ ëª©ë¡ ë¡œë“œ:
  - ê° í•˜ìœ„ ë°±ë¡œê·¸ì˜ ì œëª©, ìœ í˜•, ìƒíƒœ
  - ì´ë¯¸ ì™„ë£Œëœ í•­ëª© í‘œì‹œ
  - ì§„í–‰ ì¤‘ì¸ í•­ëª© í‘œì‹œ
  </action>
</check>

<check if="children found">
  <action>ê¸°ì¡´ í•˜ìœ„ ë°±ë¡œê·¸ ìš”ì•½ í‘œì‹œ:

"**ê¸°ì¡´ í•˜ìœ„ ë°±ë¡œê·¸ ({child_count}ê°œ):**

| #   | ìœ í˜• | ì œëª© | ìƒíƒœ |
| --- | ---- | ---- | ---- |

{children_table}

âš ï¸ ê¸°ì¡´ í•˜ìœ„ ë°±ë¡œê·¸ê°€ ìˆìŠµë‹ˆë‹¤. ì¶”ê°€ ë¶„í•´ ì‹œ ì¤‘ë³µì— ì£¼ì˜í•˜ì„¸ìš”."
</action>
</check>
</action>

<action>ì—°ê²°ëœ ë°±ë¡œê·¸ ì •ë³´ ìˆ˜ì§‘:

**2.3 ì—°ê²°ëœ ë°±ë¡œê·¸ íƒìƒ‰:**

<check if="notion_integration == auto">
  <action>ë…¸ì…˜ì—ì„œ ê´€ê³„ ì†ì„±ë“¤ ì¡°íšŒ:
  - Blocks / Blocked By (ì°¨ë‹¨ ê´€ê³„)
  - Related (ì—°ê´€ ê´€ê³„)
  - Dependencies (ì˜ì¡´ ê´€ê³„)
  </action>
</check>

<check if="related backlogs found">
  <action>ì—°ê²° ê´€ê³„ í‘œì‹œ:

"**ì—°ê²°ëœ ë°±ë¡œê·¸:**

- **ì°¨ë‹¨ë¨:** {blocking_items}
- **ì°¨ë‹¨ ì¤‘:** {blocked_by_items}
- **ì—°ê´€:** {related_items}
- **ì˜ì¡´:** {dependency_items}"
  </action>
  </check>
  </action>

<action>ì¢…í•© ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ìƒì„±:

"**ğŸ“Š ë°±ë¡œê·¸ ì»¨í…ìŠ¤íŠ¸ ë¶„ì„ ì™„ë£Œ**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**í˜„ì¬ ë°±ë¡œê·¸:**

- {backlog_type}: {backlog_title}

**ê³„ì¸µ êµ¬ì¡°:**

```
{parent_title} ({parent_type})  â† ìƒìœ„
â””â”€â”€ {backlog_title} ({backlog_type})  â† í˜„ì¬
    â””â”€â”€ {existing_children_summary}  â† ê¸°ì¡´ í•˜ìœ„
```

**ì—°ê²° ê´€ê³„:**
{connection_summary}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
</action>

<template-output>context_analysis</template-output>
</step>

<step n="3" goal="ìš”êµ¬ì‚¬í•­ ë° ìˆ˜ìš©ê¸°ì¤€ êµ¬ì¡°í™”">
<critical>ìƒìœ„ ë°±ë¡œê·¸ ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ìš”êµ¬ì‚¬í•­ì„ ì™„ì „í•˜ê²Œ êµ¬ì¡°í™”í•©ë‹ˆë‹¤.</critical>

<action>ìš”êµ¬ì‚¬í•­ ì¶”ì¶œ ë° ë²ˆí˜¸ ë¶€ì—¬:

**3.1 ìš”êµ¬ì‚¬í•­ íŒŒì‹±:**

ìƒìœ„ ë°±ë¡œê·¸ì™€ í˜„ì¬ ë°±ë¡œê·¸ì˜ ì„¤ëª…ì—ì„œ ê°œë³„ ìš”êµ¬ì‚¬í•­ì„ ì¶”ì¶œí•˜ê³  REQ-XXX í˜•ì‹ìœ¼ë¡œ ë²ˆí˜¸ ë¶€ì—¬:

```yaml
requirements:
  - id: REQ-001
    content: '{ì²« ë²ˆì§¸ ìš”êµ¬ì‚¬í•­}'
    type: functional | non-functional | technical | business
    source: current | parent | inferred
    priority: high | medium | low

  - id: REQ-002
    content: '{ë‘ ë²ˆì§¸ ìš”êµ¬ì‚¬í•­}'
    type: functional
    source: current
    priority: medium
```

**ì¶”ì¶œ ê¸°ì¤€:**

- ê¸°ëŠ¥ì  ìš”êµ¬ì‚¬í•­ (ì‚¬ìš©ìê°€ í•  ìˆ˜ ìˆì–´ì•¼ í•˜ëŠ” ê²ƒ)
- ë¹„ê¸°ëŠ¥ì  ìš”êµ¬ì‚¬í•­ (ì„±ëŠ¥, ë³´ì•ˆ, ì ‘ê·¼ì„± ë“±)
- ê¸°ìˆ ì  ì œì•½ì‚¬í•­ (íŠ¹ì • ê¸°ìˆ  ì‚¬ìš©, API í˜¸í™˜ì„± ë“±)
- ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ (ì •ì±…, ì œí•œ ë“±)
  </action>

<action>ìˆ˜ìš© ê¸°ì¤€ ì¶”ì¶œ ë° ë²ˆí˜¸ ë¶€ì—¬:

**3.2 ìˆ˜ìš© ê¸°ì¤€ íŒŒì‹±:**

```yaml
acceptance_criteria:
  - id: AC-001
    content: '{ì²« ë²ˆì§¸ ìˆ˜ìš© ê¸°ì¤€}'
    testable: true
    related_requirements: [REQ-001, REQ-002]

  - id: AC-002
    content: '{ë‘ ë²ˆì§¸ ìˆ˜ìš© ê¸°ì¤€}'
    testable: true
    related_requirements: [REQ-003]
```

ìˆ˜ìš© ê¸°ì¤€ì´ ëª…ì‹œì ìœ¼ë¡œ ì—†ëŠ” ê²½ìš°:

- ìš”êµ¬ì‚¬í•­ì—ì„œ ì•”ë¬µì  ìˆ˜ìš© ê¸°ì¤€ ë„ì¶œ
- [INFERRED] íƒœê·¸ ì¶”ê°€
  </action>

<action>êµ¬ì¡°í™”ëœ ìš”êµ¬ì‚¬í•­ í‘œì‹œ:

"**ğŸ“‹ ìš”êµ¬ì‚¬í•­ êµ¬ì¡°í™” ì™„ë£Œ**

**ìš”êµ¬ì‚¬í•­ ({req_count}ê°œ):**

| ID  | ë‚´ìš© | ìœ í˜• | ì¶œì²˜ | ìš°ì„ ìˆœìœ„ |
| --- | ---- | ---- | ---- | -------- |

{requirements_table}

**ìˆ˜ìš© ê¸°ì¤€ ({ac_count}ê°œ):**

| ID  | ë‚´ìš© | í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ | ê´€ë ¨ ìš”êµ¬ì‚¬í•­ |
| --- | ---- | ----------- | ------------- |

{acceptance_criteria_table}
"
</action>

<ask>ìš”êµ¬ì‚¬í•­ ë¶„ì„ì´ ì •í™•í•œê°€ìš”?

1. ì •í™•í•¨ - ê³„ì† ì§„í–‰
2. ìˆ˜ì • í•„ìš” - ìš”êµ¬ì‚¬í•­/ìˆ˜ìš©ê¸°ì¤€ ìˆ˜ì •
3. ì¶”ê°€ í•„ìš” - ëˆ„ë½ëœ í•­ëª© ì¶”ê°€</ask>

<check if="option 2 OR option 3">
  <ask>ìˆ˜ì •/ì¶”ê°€í•  ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”:</ask>
  <action>ìš”êµ¬ì‚¬í•­/ìˆ˜ìš©ê¸°ì¤€ ì—…ë°ì´íŠ¸</action>
</check>

<template-output>requirements_structured</template-output>
</step>

<step n="4" goal="ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘ (í”¼ê·¸ë§ˆ, ì°¸ì¡° ë¬¸ì„œ ë“±)">
<critical>êµ¬í˜„ì— í•„ìš”í•œ ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</critical>

<action>í”¼ê·¸ë§ˆ ë§í¬ ê°ì§€ ë° ì •ë³´ ì¶”ì¶œ:

**4.1 í”¼ê·¸ë§ˆ ë§í¬ íŒŒì‹±:**

ë°±ë¡œê·¸ ë‚´ìš©ì—ì„œ ë‹¤ìŒ íŒ¨í„´ ê²€ìƒ‰:

- `https://www.figma.com/file/{file_key}...`
- `https://www.figma.com/design/{file_key}...`
- `node-id={node_id}` ë˜ëŠ” `?node-id={node_id}`
- ì§ì ‘ ë…¸ë“œ ID: `{number}:{number}` í˜•ì‹

<check if="figma links found">
  <action>í”¼ê·¸ë§ˆ ì •ë³´ ì¶”ì¶œ ë° ì €ì¥:

```yaml
figma:
  url: { full_figma_url }
  file_key: { extracted_file_key }
  node_id: { extracted_node_id }
  detected_in: description | acceptance_criteria | comment
```

  </action>

<action>í”¼ê·¸ë§ˆ ì •ë³´ í‘œì‹œ:

"**ğŸ¨ í”¼ê·¸ë§ˆ ë””ìì¸ ê°ì§€ë¨:**

- URL: {figma_url}
- íŒŒì¼ í‚¤: {file_key}
- ë…¸ë“œ ID: {node_id}

â†’ ì´ ì •ë³´ëŠ” í•˜ìœ„ ë°±ë¡œê·¸ì— ìë™ ì „íŒŒë©ë‹ˆë‹¤."
</action>
</check>
</action>

<action>ì°¸ì¡° ë¬¸ì„œ ë° ë§í¬ ìˆ˜ì§‘:

**4.2 ì°¸ì¡° ë¬¸ì„œ íŒŒì‹±:**

ë°±ë¡œê·¸ ë‚´ìš©ì—ì„œ ì°¸ì¡° ë§í¬ ê²€ìƒ‰:

- API ë¬¸ì„œ ë§í¬
- ê¸°ìˆ  ìŠ¤í™ ë¬¸ì„œ
- ì™¸ë¶€ ì„œë¹„ìŠ¤ ë¬¸ì„œ
- ë‚´ë¶€ ìœ„í‚¤/ë¬¸ì„œ

```yaml
references:
  - type: api_doc
    url: { url }
    title: { title }

  - type: external_service
    url: { url }
    title: { title }
```

</action>

<action>ë¶ˆëª…í™•í•œ í•­ëª© ì‹ë³„:

**4.3 ë¶ˆëª…í™•/ëª¨í˜¸í•œ ë¶€ë¶„ ì²´í¬:**

ìš”êµ¬ì‚¬í•­ê³¼ ìˆ˜ìš©ê¸°ì¤€ì—ì„œ ë¶ˆëª…í™•í•œ ë¶€ë¶„ ì‹ë³„:

- "ì ì ˆí•œ", "ë¹ ë¥¸", "ì¢‹ì€" ë“± ëª¨í˜¸í•œ í‘œí˜„
- êµ¬ì²´ì  ìˆ˜ì¹˜ê°€ ì—†ëŠ” ì„±ëŠ¥ ìš”êµ¬ì‚¬í•­
- ì •ì˜ë˜ì§€ ì•Šì€ ìš©ì–´ë‚˜ ê°œë…
- ì•”ë¬µì ì¸ ê°€ì •

<check if="unclear items found">
```yaml
unclear_items:
  - item: REQ-003
    issue: "ì ì ˆí•œ ì‘ë‹µ ì‹œê°„"ì´ êµ¬ì²´ì ì´ì§€ ì•ŠìŒ
    suggestion: êµ¬ì²´ì ì¸ ms ë‹¨ìœ„ ì§€ì • í•„ìš”

- item: AC-002
  issue: "ì‚¬ìš©ì ì¹œí™”ì " ì •ì˜ í•„ìš”
  suggestion: êµ¬ì²´ì ì¸ UX ê¸°ì¤€ ëª…ì‹œ í•„ìš”

````
</check>
</action>

<check if="unclear_items exist">
  <action>ë¶ˆëª…í™•í•œ í•­ëª© í‘œì‹œ:

"**âš ï¸ ë¶ˆëª…í™•í•œ í•­ëª© ë°œê²¬:**

| í•­ëª© | ì´ìŠˆ | ì œì•ˆ |
|-----|------|------|
{unclear_items_table}

ì´ í•­ëª©ë“¤ì€ ë¶„í•´ ì „ì— ëª…í™•íˆ í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤."
  </action>

  <ask>ë¶ˆëª…í™•í•œ í•­ëª©ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í• ê¹Œìš”?

- [c] ëª…í™•í™” - ì§€ê¸ˆ ë°”ë¡œ ëª…í™•í•˜ê²Œ ì •ì˜
- [l] ë‚˜ì¤‘ì— - ë¶„í•´ ê³¼ì •ì—ì„œ ì²˜ë¦¬
- [s] ê±´ë„ˆë›°ê¸° - í˜„ì¬ ìƒíƒœë¡œ ì§„í–‰</ask>

  <check if="c">
    <ask>ê° ë¶ˆëª…í™•í•œ í•­ëª©ì— ëŒ€í•œ ëª…í™•í•œ ì •ì˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”:</ask>
    <action>ìš”êµ¬ì‚¬í•­/ìˆ˜ìš©ê¸°ì¤€ ì—…ë°ì´íŠ¸</action>
  </check>
</check>

<action>ì»¨í…ìŠ¤íŠ¸ ìš”ì•½ ìƒì„±:

```yaml
context_notes:
  figma: {figma_info}
  references: {references_list}
  unclear_items: {unclear_items_list}
  parent_context: {parent_summary}
  existing_children: {children_summary}
  connections: {connections_summary}
````

</action>

<template-output>context_collected</template-output>
</step>

<step n="5" goal="ì»¨í…ìŠ¤íŠ¸ ì¶©ì¡±ë„ ê²€ì¦ ë° ë¶€ì¡±í•œ ì •ë³´ ìˆ˜ì§‘">
<critical>ë¶„í•´ì— í•„ìš”í•œ í•„ìˆ˜ ì»¨í…ìŠ¤íŠ¸ê°€ ì¶©ë¶„í•œì§€ ê²€ì¦í•˜ê³ , ë¶€ì¡±í•œ ê²½ìš° ì ê·¹ì ìœ¼ë¡œ ìš”ì²­í•©ë‹ˆë‹¤.</critical>

<action>gather-context íƒœìŠ¤í¬ ì‹¤í–‰: {gather_context_task}

**ì „ë‹¬í•  íŒŒë¼ë¯¸í„°:**

- backlog_type: {backlog_type}
- backlog_title: {backlog_title}
- backlog_description: {raw_description}
- requirements: {requirements}
- acceptance_criteria: {acceptance_criteria}
- existing_context: - figma: {figma_info} - references: {references_list} - parent_info: {parent_summary}
  </action>

<invoke-task path="{gather_context_task}">
  <param name="backlog_type">{backlog_type}</param>
  <param name="backlog_title">{backlog_title}</param>
  <param name="requirements">{requirements}</param>
  <param name="acceptance_criteria">{acceptance_criteria}</param>
  <param name="existing_context">{context_notes}</param>
</invoke-task>

<action>íƒœìŠ¤í¬ ê²°ê³¼ ì €ì¥:

- context_score: {context_score}
- can_decompose: {can_decompose}
- missing_required: {missing_required}
- missing_recommended: {missing_recommended}
- gathered_context: {gathered_context}
  </action>

<check if="context_score < 50">
  <action>ê²½ê³  í‘œì‹œ:

"**âš ï¸ ì»¨í…ìŠ¤íŠ¸ ì¶©ì¡±ë„ ë‚®ìŒ: {context_score}%**

í•„ìˆ˜ ì •ë³´ê°€ ë§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë¶„í•´ ì „ì— ì¶”ê°€ ì •ë³´ ìˆ˜ì§‘ì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤."
</action>
</check>

<check if="context_score >= 50 AND context_score < 80">
  <action>ì•Œë¦¼ í‘œì‹œ:

"**â„¹ï¸ ì»¨í…ìŠ¤íŠ¸ ì¶©ì¡±ë„: {context_score}%**

ì¼ë¶€ ì •ë³´ê°€ ë¶€ì¡±í•˜ì§€ë§Œ ë¶„í•´ëŠ” ê°€ëŠ¥í•©ë‹ˆë‹¤. ê°€ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
</action>
</check>

<check if="context_score >= 80">
  <action>í™•ì¸ í‘œì‹œ:

"**âœ… ì»¨í…ìŠ¤íŠ¸ ì¶©ì¡±ë„: {context_score}%**

ë¶„í•´ì— í•„ìš”í•œ ì •ë³´ê°€ ì¶©ë¶„íˆ ìˆ˜ì§‘ë˜ì—ˆìŠµë‹ˆë‹¤."
</action>
</check>

<check if="gathered_context exists">
  <action>ìˆ˜ì§‘ëœ ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸ë¥¼ context_notesì— ë³‘í•©</action>
</check>

<template-output>context_verified</template-output>
</step>

<step n="6" goal="ë°±ë¡œê·¸ ì •ë³´ ì €ì¥">

<check if="skip_save == true">
  <action>ì €ì¥ ê±´ë„ˆë›°ê¸° - í˜¸ì¶œ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì²˜ë¦¬</action>
  <goto step="7">Return results</goto>
</check>

<action>ì €ì¥ í´ë” ê²½ë¡œ ê²°ì •: {output_folder}/{backlog_id}/</action>

<action>ë°±ë¡œê·¸ í´ë” ìƒì„±</action>

<action>backlog-info.yaml ì €ì¥:

```yaml
# ë°±ë¡œê·¸ ë©”íƒ€ì •ë³´ - Prepared by prepare-backlog workflow
backlog_id: { backlog_id }
title: { backlog_title }
type: { backlog_type }
status: prepared
notion_id: { notion_page_id }
created_at: { date }
prepared_at: { date }

# ê³„ì¸µ ì •ë³´
hierarchy:
  parent:
    id: { parent_id }
    title: { parent_title }
    type: { parent_type }
    notion_id: { parent_notion_id }
  existing_children:
    count: { children_count }
    items: { children_list }
  connections:
    blocking: { blocking_list }
    blocked_by: { blocked_by_list }
    related: { related_list }

# ğŸ“‹ êµ¬ì¡°í™”ëœ ìš”êµ¬ì‚¬í•­
requirements: { requirements_yaml }

# âœ… êµ¬ì¡°í™”ëœ ìˆ˜ìš© ê¸°ì¤€
acceptance_criteria: { acceptance_criteria_yaml }

# ğŸ¨ ì»¨í…ìŠ¤íŠ¸
context:
  figma:
    url: { figma_url }
    file_key: { figma_file_key }
    node_id: { figma_node_id }
  references: { references_yaml }
  unclear_items: { unclear_items_yaml }

# ì›ë³¸ ë°ì´í„°
raw:
  description: |
    {raw_description}
  acceptance_criteria: |
    {raw_acceptance_criteria}
```

</action>

<action>ì €ì¥ ì™„ë£Œ ë©”ì‹œì§€:

"âœ… ë°±ë¡œê·¸ ì •ë³´ ì €ì¥ ì™„ë£Œ

- ìœ„ì¹˜: {output_folder}/{backlog_id}/
- íŒŒì¼: backlog-info.yaml"
  </action>

<template-output>backlog_saved</template-output>
</step>

<step n="7" goal="ì™„ë£Œ ë° ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´">

<action>ì¤€ë¹„ ì™„ë£Œ ìš”ì•½ í‘œì‹œ:

"**âœ… ë°±ë¡œê·¸ ì¤€ë¹„ ì™„ë£Œ!**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**ë°±ë¡œê·¸:** {backlog_type} - {backlog_title}

**ë¶„ì„ ê²°ê³¼:**

- ìš”êµ¬ì‚¬í•­: {req_count}ê°œ (REQ-001 ~ REQ-{req_count})
- ìˆ˜ìš© ê¸°ì¤€: {ac_count}ê°œ (AC-001 ~ AC-{ac_count})
- ë¶ˆëª…í™• í•­ëª©: {unclear_count}ê°œ
- ì»¨í…ìŠ¤íŠ¸ ì¶©ì¡±ë„: {context_score}%

**ì»¨í…ìŠ¤íŠ¸:**

- ìƒìœ„ ë°±ë¡œê·¸: {parent_summary}
- ê¸°ì¡´ í•˜ìœ„: {children_count}ê°œ
- í”¼ê·¸ë§ˆ: {figma_status}
- ì°¸ì¡° ë¬¸ì„œ: {ref_count}ê°œ

**ì €ì¥ ìœ„ì¹˜:** {output_folder}/{backlog_id}/

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
</action>

<check if="invoked from another workflow">
  <action>ê²°ê³¼ê°’ ë°˜í™˜:
  - backlog_id: {backlog_id}
  - backlog_info: {backlog_info_yaml}
  - requirements: {requirements}
  - acceptance_criteria: {acceptance_criteria}
  - context_notes: {context_notes}
  - context_score: {context_score}
  - backlog_folder: {output_folder}/{backlog_id}
  </action>
  <action>í˜¸ì¶œ ì›Œí¬í”Œë¡œìš°ë¡œ ì œì–´ ë°˜í™˜</action>
</check>

<check if="standalone execution">
  <ask>ë‹¤ìŒ ì‘ì—…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”:

1. ì½”ë“œë² ì´ìŠ¤ ë¶„ì„ ì§„í–‰ (\*analyze-code)
2. ë°±ë¡œê·¸ ë¶„í•´ ì§„í–‰ (\*decompose)
3. ë‹¤ë¥¸ ë°±ë¡œê·¸ ì¤€ë¹„
4. ì™„ë£Œ</ask>

  <check if="option 1">
    <action>analyze-codebase ì›Œí¬í”Œë¡œìš° ì•ˆë‚´</action>
  </check>

  <check if="option 2">
    <action>decompose-backlog ì›Œí¬í”Œë¡œìš° ì•ˆë‚´</action>
  </check>

  <check if="option 3">
    <goto step="1">Prepare another backlog</goto>
  </check>
</check>

<template-output>completion_summary</template-output>
</step>

</workflow>
